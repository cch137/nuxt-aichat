import{aP as Ve,cs as Ke,ct as Xe,cu as Ye,cv as Ze,K as ye,b1 as k,cw as et,cx as tt,cy as nt,G as we,r as m,g as B,ac as Te,X as ot,E as h,h as me,cz as rt,C as at,u as st,z as _,W as b,y as H,k as Ce,aR as it}from"./entry.6d4bc728.js";import{E as z}from"./el-overlay.76341463.js";import"./el-button.5df17117.js";import"./el-input.498d553c.js";import{u as ct}from"./useAuth.5ae74288.js";import{u as ve}from"./useTitle.3f1c74d3.js";var lt=Ke,ut=Xe,ft=Ye,dt={formats:ft,parse:ut,stringify:lt};const be=Ve(dt),{MT:pe,shuffle:mt,randInt:F}=ye,{convert:vt,getCharset:pt}=k,gt=(e,t)=>{const n=mt(e,t);return()=>(n.push(n.shift()),n)},Ae=(e,t=16,n=1,o)=>{const i=Number.isNaN(+t)?64:+t,c=pt(t),a=Ze(o!==void 0?o:F(0,i)),A=pe(a),T=gt(c,pe(F(0,1e6,A))),y=typeof e=="string"?e.split(""):e,f=[o!==void 0?c[F(0,i)]:vt(a,10,t),...y.map(L=>T()[c.indexOf(L)])];return--n<1?f.join(""):Ae(f,t,n,o)},{textToBase64:ht,base64ToText:Jt,secureBase64:yt}=k;function wt(e,t=1,n){return typeof e=="object"?e=nt(e):typeof e!="string"&&(e=we(e)),Ae(yt(ht(e)),64,t,n)}function Tt(e,t=512,n){const o=wt(e,1,n).substring(1);return t==="MD5"?et(o).toString():tt(o,{outputLength:t}).toString()}const Ct={get isMobileScreen(){return window.innerWidth<600},get isTouchScreen(){return"ontouchstart"in document||navigator.maxTouchPoints>0}};function Q(){return Ct}const bt=new Map([["THINKING","Please wait, I am answering another question..."]]);function At(e,t){switch(e){case"model":if(["gpt3","gpt4","gpt-web","claude-2","gemini-pro"].includes(t))return!0;break;case"temperature":if(typeof t=="number"&&t>=0&&t<=1)return!0;break;case"context":if(typeof t=="boolean")return!0;break}return!1}function St(e){try{return JSON.parse(e)}catch{return e}}function Se(e){try{const t={};for(const n in e){const o=St(e[n]);At(n,o)&&(t[n]=o)}return t}catch{return{}}}function xt(e){try{return Se(be.parse(e))}catch{return{}}}function Et(e){try{return be.stringify(Se(e))}catch{return""}}const O=0,V=[{name:"GPT-3.5-Turbo",value:"gpt3",isWebBrowsingOptional:!1,isTemperatureOptional:!0,isContextOptional:!0,isStreamAvailable:!0,permissionLevel:O},{name:"GPT-4",value:"gpt4",isWebBrowsingOptional:!1,isTemperatureOptional:!0,isContextOptional:!0,isStreamAvailable:!0,permissionLevel:O},{name:"GPT-Web",value:"gpt-web",isWebBrowsingOptional:!1,isTemperatureOptional:!0,isContextOptional:!0,isStreamAvailable:!1,permissionLevel:O,redirectTo:"gpt3"},{name:"Claude-2",value:"claude-2",isWebBrowsingOptional:!1,isTemperatureOptional:!0,isContextOptional:!0,isStreamAvailable:!0,permissionLevel:O},{name:"Claude-2 (Web)",value:"claude-2-web",isWebBrowsingOptional:!1,isTemperatureOptional:!0,isContextOptional:!0,isStreamAvailable:!0,permissionLevel:O,redirectTo:"claude-2"},{name:"GPT-3.5-Turbo (stream)",value:"gpt3-fga",isWebBrowsingOptional:!1,isTemperatureOptional:!0,isContextOptional:!0,isStreamAvailable:!0,permissionLevel:O,redirectTo:"gpt3"},{name:"GPT-4 (stream)",value:"gpt4-fga",isWebBrowsingOptional:!1,isTemperatureOptional:!0,isContextOptional:!0,isStreamAvailable:!0,permissionLevel:O,redirectTo:"gpt4"},{name:"Gemini-Pro",value:"gemini-pro",isWebBrowsingOptional:!1,isTemperatureOptional:!1,isContextOptional:!0,isStreamAvailable:!0,permissionLevel:O}];let Y,ge="";const E=m("gpt4"),M=m(!0),I=m(.5),l=m([]),x=m([]),xe=m(),Z=m(!1),Ee=m("");function Ot(e){Z.value=!0,xe.value=e,Ee.value=e.Q,setTimeout(()=>Pt(),0)}function Pt(){try{document.querySelector(".EditQuestionInput textarea").focus()}catch{}}B(Z,e=>e?null:g());const Oe=m(),ee=m(!1),Pe=m("");function kt(e){ee.value=!0,Oe.value=e,Pe.value=e.A,setTimeout(()=>Bt(),0)}function Bt(){try{document.querySelector(".EditAnswerInput textarea").focus()}catch{}}B(ee,e=>e?null:g());const g=()=>{try{{if(Q().isMobileScreen)return;const e=document.querySelector(".InputBox textarea");e.click(),e.focus()}}catch{}},ke=()=>{try{const e=document.getElementById(d()).parentElement,t=document.querySelector(".ConversationList"),n=e.offsetTop-t.offsetTop-e.clientHeight/2,o=n-t.clientHeight+e.clientHeight*2;t.scrollTop>n&&t.scrollTo({left:0,top:n,behavior:"smooth"}),t.scrollTop<o&&t.scrollTo({left:0,top:o,behavior:"smooth"})}catch{}},N=()=>new Promise((e,t)=>{$fetch("/api/curva/check",{method:"POST"}).then(n=>{x.value=n,ke(),e(!0)}).catch(n=>{h.error("Initialization Failed"),t(n)})}),Mt=e=>new Promise(async(t,n)=>{if(e==null)return t([]);const o=await $fetch("/api/curva/history",{method:"POST",body:{id:e}});(!o||o.length===0)&&_("/c/");try{t(o.map(i=>Ce({...i,t:new Date(i.t),done:!0})))}catch{_("/c/"),t([])}}),Be=async function(e){return[]},It=async()=>{try{const e=l.value.at(-1),t=await Be(e.Q),n=b.isAtBottom();e.more=t,n&&b()}catch(e){console.error(e)}},te=(e=!1)=>{E.value="gpt4",M.value=!0,I.value=.5,e&&h.success("Conversation settings have been reset.")};te();const w=m(!1),ne=m(w.value),oe=m(w.value);B(ne,e=>{w.value=e});B(oe,e=>{w.value=e});B(w,e=>{const{isMobileScreen:t}=Q();ne.value=t?!1:e,oe.value=t?e:!1,setTimeout(()=>g(),0)});{let e,t=Q().isMobileScreen?"drawer":"sidebar";window.addEventListener("resize",()=>{clearTimeout(e),e=setTimeout(()=>{const n=Q().isMobileScreen?"drawer":"sidebar";w.value&&n!=t&&(w.value=!1,setTimeout(()=>{w.value=!0},0),t=n)},100)})}const D=m(""),Lt=Te(()=>E.value.startsWith("claude")?64e4:128e3),$t=(()=>{const e=()=>[77,68,53].map(o=>String.fromCharCode(o)).join(""),t=(o,i)=>({hash:Tt(o,e(),i),timestamp:we(i)}),n=(o,i,c,a,A,T,y)=>{let f=d();return f||(f=ye.base64(8),x.value.unshift({id:f,name:"",mtime:Date.now(),config:""}),_(`/c/${f}?feature=new`),Me(f)),{conv:f,messages:o,model:i,temperature:c,t:a,tz:A,id:T,streamId:y}};return async(o,i)=>{const c=new Date,a=c.getTime(),A=c.getTimezoneOffset()/60*-1,T=(()=>{if(!M.value)return[{role:"user",content:(o==null?void 0:o.Q)||""}];const y=l.value.lastIndexOf(o)+1||l.value.length;let f=l.value.slice(0,y);return f=f.slice(f.length-100),f.map(L=>[{role:"user",content:L.Q},{role:"assistant",content:L.A}].filter(se=>se.content)).flat()})();try{const y=n(T,E.value,I.value,a,A,o==null?void 0:o.id,i),f=t(T,a);return await $fetch("/api/curva/answer",{method:"POST",headers:f,body:y})}catch(y){return{answer:"",error:(y==null?void 0:y.message)||"Error while sending request."}}}})(),Qt=(e="",t="",n=!1)=>Ce({done:n,Q:e,A:t,queries:[],urls:[],dt:void 0,t:new Date}),W=new Set,J=()=>{x.value=[],l.value=[],_("/c/"),K=!0};let K=!0;function he(){{const e=it();e.get("feature")==="new"&&(e.delete("feature"),e.save(),ae())}}const re=(e,t)=>{const n=document.createElement("a");n.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(t)),n.setAttribute("download",e),n.style.display="none",document.body.appendChild(n),n.click(),n.remove()},[qt,d,Me]=(()=>{const e=m("");return[Te(()=>e.value),()=>e.value,t=>{var n,o;return e.value=t===void 0?(o=(n=Y._route)==null?void 0:n.params)==null?void 0:o.conv:t}]})(),G=()=>{var t;const e=d();return((t=x.value.find(n=>n.id===e))==null?void 0:t.name)||""};async function ae(e,t){return e=e||d(),e?await $fetch("/api/curva/conv",{method:"PUT",body:{id:e,name:t||G(),config:Et({model:E.value,temperature:I.value,context:M.value})}}):{cancel:!0}}let X=!1;const Nt=e=>{var o,i;if(e===void 0&&(e=d()),e==null)return;const t=xt(((o=x.value.find(c=>c.id===e))==null?void 0:o.config)||""),n=Object.keys(t);if(n.length===0)te();else{X=!0;try{for(const c of n){const a=t[c];switch(c){case"model":const A=(i=V.find(T=>T.value===a))==null?void 0:i.redirectTo;E.value=A||a;break;case"temperature":I.value=a;break;case"context":M.value=a;break}}}finally{X=!1}}h.info("Conversation settings have been loaded.")};setTimeout(()=>{let e;[E,M,I].forEach(t=>{B(t,(n,o)=>{Y&&!X&&n!==o&&W.size===0&&(clearTimeout(e),e=setTimeout(async()=>{try{const{cancel:i=!1}=await ae();i||h.info("Conversation settings have been saved.")}catch(i){console.error(i),h.warning("Failed to save conversation settings.")}finally{clearTimeout(e)}},typeof t.value=="number"?500:0))})})},1e3);const Dt=(e,t)=>{t!==void 0&&(e[t]="");const{id:n,Q:o,A:i}=e;l.value=l.value.filter(c=>c.Q||c.A),$fetch("/api/curva/message",{method:"PUT",body:{conv:d(),id:n,Q:o,A:i}}).then(()=>h.info(`The message has been ${t?"deleted":"saved"}.`)).catch(()=>h.error(`An error occurred while ${t?"deleting":"saving"} the message.`))},Wt=()=>{let e=0;const t=`${k.convert(d(),"64w",10)}.md`,n=l.value.map(o=>{e++;try{return(o.t?`${new Date(o.t.getTime()-(o.dt||0)).toLocaleString()}${o.dt===void 0?"":" (Î”t: "+o.dt.toString()+"ms)"}

`:"")+(o.Q?`QUESTION ${e}:

${o.Q.replaceAll(`
`,`

`)}`:"")+(o.Q&&o.A?`

`:"")+(o.A?`ANSWER ${e}:

${o.A}`:"")}catch{return"(Unknown message)"}}).join(`

---

`)+`

---

`;re(t,n)},Gt=()=>{const e=l.value.map(t=>[{role:"user",content:t.Q},{role:"assistant",content:t.A}]).flat().filter(t=>t.content);re(`${k.convert(d(),"64w",10)}.json`,JSON.stringify(e,null,4))},_t=()=>{const e=l.value.map(t=>{var n,o;return[{role:"user",content:t.Q},{role:"assistant",content:t.A,queries:(n=t.queries)!=null&&n.length?t.queries:void 0,urls:(o=t.urls)!=null&&o.length?t.urls:void 0,createdAt:new Date(t.t.getTime()).toUTCString(),timeUsed:t.dt||void 0}]}).flat().filter(t=>t.content);re(`${k.convert(d(),"64w",10)}.json`,JSON.stringify(e,null,4))};document.addEventListener("keyup",e=>{switch(e.key){case"/":case"Enter":g();break;case"Escape":w.value=!w.value;break}});const Ie=m(!1);document.addEventListener("scroll",()=>{Ie.value=!ot()});function Vt(){const{authEventTarget:e}=ct(),t=me("appName").value,n=rt();["temperature-suffix","web-browsing","temperature"].forEach(s=>{n.delete(s,{path:"/"}),n.delete(s)}),Y=at();const o=()=>{setTimeout(()=>{try{ve(`${G()||a("chat.title")} - ${t}`)}catch{ve(`${a("chat.title")} - ${t}`)}},0)};e.addListener("login",J),e.addListener("logout",J);const i=async s=>{setTimeout(()=>{Q().isMobileScreen&&(w.value=!1)},0),l.value=[];const v=H.service({text:a("chat.ldConv")+"...",lock:!0});try{const C=s===null&&x.value.length>0?null:N(),p=s===null?null:await Mt(s);p!==null&&d()===s&&(l.value=p,It()),await Promise.all([C,b(1e3)]),Nt(s),setTimeout(()=>o(),1e3)}finally{v.close(),await b(500),g(),ke(),await b(500)}},c=async(s,v=!1)=>{Me(s||"");const C=Promise.all([...W]),p=K&&v?new Promise(async r=>{await i(s),he(),r(null)}):v?new Promise(r=>r(null)):i(s);K=!1,W.add(p);try{await C}catch{}try{await p}finally{W.delete(p)}},a=st().t,A=me("version"),T=async(s,v)=>{if(!E.value)return h.info("Please select a model."),g(),!1;if(document.querySelectorAll(".Message.T").length>0)return h.info("Please wait for the completion of the previous question."),g(),!1;const p=(s!==void 0?s:D.value).trim();if(s===void 0&&(D.value="",p===""))return g(),!1;const r=(v?l.value.filter(u=>u.id===v).at(-1):void 0)||Qt(p,"",!1);l.value.includes(r)||l.value.push(r);const j=r.A||"";r.done=!1,r.Q=p,r.A="",r.urls=[],r.queries=[],r.dt&&(r.dt=void 0);const Le=Be(),$e=b.isAtBottom(),Qe=d();$e&&b(),g();const R=1;let q=!1;const qe=await new Promise(async u=>{var fe;if(!((fe=V.find(U=>U.value===E.value))!=null&&fe.isStreamAvailable))return u(void 0);const P=[],Re=setInterval(()=>{P.length&&(r.A+=P.shift(),b.keepAtBottom()),r.done&&(clearInterval(Re),ce.abort())},R),ce=new AbortController,Ue=await fetch("/api/curva/stream",{method:"POST",headers:{"Content-Type":"application/json"},body:"{}",signal:ce.signal}),He=new TextDecoder,ze=Ue.body.getReader();let le=!1;const ue=async()=>{await ze.read().then(async({value:U,done:Fe})=>{if(Fe){if(P.length===0){r.done=!0;return}q=!0;const Je=setInterval(()=>{P.length===0&&(r.done=!0,q=!1,clearInterval(Je))},R);return}const de=He.decode(U);le?P.push(de):(u(de),le=!0),ue()})};ue()}),Ne=await $t(r,qe);he(),ge!==Qe&&N().finally(()=>{ge=d()});const{id:De,answer:$="",error:S,urls:We=[],queries:Ge=[],dt:_e=0,version:ie}=Ne;if(q){const u=setInterval(()=>{q||(r.done=!0,r.A!==$&&(r.A=$||""),clearInterval(u))},R)}else r.done=!0,r.A!==$&&(r.A=$||"");r.t=new Date,r.dt=_e||void 0,r.id=De||void 0,r.urls=We||[],r.queries=Ge||[];const je=(u=>u?(u.type==="warning"?h.warning(u.content):h.error(u.content),r.A="Oops! Something went wrong!",!0):!1)((()=>{if($===""){if(S){const u=()=>{v?r.A=j:(l.value.pop(),D.value=p)};if(typeof S=="string"&&S.startsWith("You have tried too many times."))return u(),{type:"warning",content:S};switch(typeof S=="string"&&S.startsWith("BSONError:")&&location.reload(),S){case"THINKING":return u(),{type:"warning",content:bt.get(S)};default:return{type:"error",content:S}}}return{type:"error",content:a("error.plzRefresh")}}})());return setTimeout(async()=>{if(ie&&ie!==A.value){const u=setTimeout(()=>location.reload(),3e3);z.confirm(a("action.newVersion"),a("message.notice"),{confirmButtonText:a("message.ok"),cancelButtonText:a("message.cancel"),type:"warning"}).then(()=>g()).catch(()=>g()).finally(()=>{clearTimeout(u),H.service({text:"Loading...",lock:!0}),location.reload()})}},0),Le.then(u=>{const P=b.isAtBottom();r.more=u,P&&b()}),je};return{models:V,showScrollToBottomButton:Ie,isEditingQuestion:Z,editingQuestion:xe,editingQuestionContent:Ee,callEditQuestionDialog:Ot,isEditingAnswer:ee,editingAnswer:Oe,editingAnswerContent:Pe,callEditAnswerDialog:kt,model:E,conversations:x,messages:l,temperature:I,contextMode:M,openMenu:w,openSidebarController:ne,openDrawerController:oe,inputValue:D,inputMaxLength:Lt,currentConvIdComputed:qt,getCurrentConvId:d,getCurrentConvName:G,checkTokenAndGetConversations:N,loadChat:c,sendMessage:T,updateMessage:Dt,regenerateMessage:async s=>{if(l.value.length===0)return;const{Q:v,id:C}=s||l.value.pop();T(v||"",C)},focusInput:g,refreshConversation:()=>{c(d()).finally(()=>g())},renameConversation:(s,v="")=>{s||(s=d(),v=G()),z.prompt(a("message.renameConvHint"),a("message.setting"),{confirmButtonText:a("message.ok"),cancelButtonText:a("message.cancel"),inputValue:v,inputPlaceholder:k.convert(s,"64w",10)}).then(async({value:C})=>{try{await ae(s,C),h({type:"success",message:a("message.renameSuccess")}),await N(),o()}catch{h({type:"error",message:"Oops! Something went wrong!"})}}).catch(()=>{})},deleteConversation:s=>{const v=s||d();let C="createNewChat";z.confirm(a("message.deleteConvConfirm"),a("message.warning"),{confirmButtonText:a("message.ok"),cancelButtonText:a("message.cancel"),type:"warning"}).then(async()=>{var r;const p=H.service({text:a("chat.dltConv")+"...",lock:!0});try{await $fetch("/api/curva/conv",{method:"DELETE",body:{id:v}})}catch{}p.close(),s===d()&&((r=document.getElementById(C))==null||r.click()),x.value=x.value.filter(j=>j.id!==s)})},resetConvConfig:te,exportAsMarkdown:Wt,exportAsJson:Gt,exportAsJsonDetailed:_t,clear:J}}export{Vt as u};
