import{aQ as Je,cm as Ve,cn as Ke,co as Ye,cp as Xe,L as he,b4 as P,cq as Ze,cr as et,cs as tt,H as we,r as v,h as k,ad as ye,Y as nt,E as h,i as de,ct as ot,D as rt,g as st,A as j,X as C,z as G,l as Te,cu as at}from"./entry.6f815613.js";import{E as R}from"./el-overlay.276552bd.js";import"./el-button.721abc11.js";import"./el-input.47ef0dfc.js";import{u as it}from"./useAuth.1edd03de.js";import{u as ve}from"./useTitle.85324271.js";var ct=Ve,lt=Ke,ut=Ye,ft={formats:ut,parse:lt,stringify:ct};const be=Je(ft),{MT:me,shuffle:dt,randInt:z}=he,{convert:vt,getCharset:mt}=P,pt=(e,t)=>{const n=dt(e,t);return()=>(n.push(n.shift()),n)},Ce=(e,t=16,n=1,o)=>{const i=Number.isNaN(+t)?64:+t,c=mt(t),s=Xe(o!==void 0?o:z(0,i)),A=me(s),T=pt(c,me(z(0,1e6,A))),w=typeof e=="string"?e.split(""):e,f=[o!==void 0?c[z(0,i)]:vt(s,10,t),...w.map(I=>T()[c.indexOf(I)])];return--n<1?f.join(""):Ce(f,t,n,o)},{textToBase64:gt,base64ToText:Ft,secureBase64:ht}=P;function wt(e,t=1,n){return typeof e=="object"?e=tt(e):typeof e!="string"&&(e=we(e)),Ce(ht(gt(e)),64,t,n)}function yt(e,t=512,n){const o=wt(e,1,n).substring(1);return t==="MD5"?Ze(o).toString():et(o,{outputLength:t}).toString()}const Tt={get isMobileScreen(){return window.innerWidth<600},get isTouchScreen(){return"ontouchstart"in document||navigator.maxTouchPoints>0}};function $(){return Tt}const bt=new Map([["THINKING","Please wait, I am answering another question..."]]);function Ct(e,t){switch(e){case"model":if(["gpt3","gpt4","gpt-web","claude-2","claude-2-web","gpt3-fga","gpt4-fga"].includes(t))return!0;break;case"temperature":if(typeof t=="number"&&t>=0&&t<=1)return!0;break;case"context":if(typeof t=="boolean")return!0;break}return!1}function At(e){try{return JSON.parse(e)}catch{return e}}function Ae(e){try{const t={};for(const n in e){const o=At(e[n]);Ct(n,o)&&(t[n]=o)}return t}catch{return{}}}function St(e){try{return Ae(be.parse(e))}catch{return{}}}function xt(e){try{return be.stringify(Ae(e))}catch{return""}}const J=[{name:"GPT-3.5-Turbo",value:"gpt3",isWebBrowsingOptional:!1,isTemperatureOptional:!0,isContextOptional:!0,isStreamAvailable:!0,permissionLevel:2},{name:"GPT-4",value:"gpt4",isWebBrowsingOptional:!1,isTemperatureOptional:!0,isContextOptional:!0,isStreamAvailable:!0,permissionLevel:2},{name:"GPT-Web",value:"gpt-web",isWebBrowsingOptional:!1,isTemperatureOptional:!0,isContextOptional:!0,isStreamAvailable:!1,permissionLevel:2,redirectTo:"gpt3"},{name:"Claude-2",value:"claude-2",isWebBrowsingOptional:!1,isTemperatureOptional:!0,isContextOptional:!0,isStreamAvailable:!0,permissionLevel:2},{name:"Claude-2 (Web)",value:"claude-2-web",isWebBrowsingOptional:!1,isTemperatureOptional:!0,isContextOptional:!0,isStreamAvailable:!0,permissionLevel:2},{name:"GPT-3.5-Turbo (stream)",value:"gpt3-fga",isWebBrowsingOptional:!1,isTemperatureOptional:!0,isContextOptional:!0,isStreamAvailable:!0,permissionLevel:2,redirectTo:"gpt3"},{name:"GPT-4 (stream)",value:"gpt4-fga",isWebBrowsingOptional:!1,isTemperatureOptional:!0,isContextOptional:!0,isStreamAvailable:!0,permissionLevel:2,redirectTo:"gpt4"}];let Y,pe="";const x=v("gpt4"),M=v(!0),B=v(.5),l=v([]),S=v([]),Se=v(),X=v(!1),xe=v("");function Et(e){X.value=!0,Se.value=e,xe.value=e.Q,setTimeout(()=>Ot(),0)}function Ot(){try{document.querySelector(".EditQuestionInput textarea").focus()}catch{}}k(X,e=>e?null:g());const Ee=v(),Z=v(!1),Oe=v("");function Pt(e){Z.value=!0,Ee.value=e,Oe.value=e.A,setTimeout(()=>kt(),0)}function kt(){try{document.querySelector(".EditAnswerInput textarea").focus()}catch{}}k(Z,e=>e?null:g());const g=()=>{try{{if($().isMobileScreen)return;const e=document.querySelector(".InputBox textarea");e.click(),e.focus()}}catch{}},Pe=()=>{try{const e=document.getElementById(d()).parentElement,t=document.querySelector(".ConversationList"),n=e.offsetTop-t.offsetTop-e.clientHeight/2,o=n-t.clientHeight+e.clientHeight*2;t.scrollTop>n&&t.scrollTo({left:0,top:n,behavior:"smooth"}),t.scrollTop<o&&t.scrollTo({left:0,top:o,behavior:"smooth"})}catch{}},q=()=>new Promise((e,t)=>{$fetch("/api/curva/check",{method:"POST"}).then(n=>{S.value=n,Pe(),e(!0)}).catch(n=>{h.error("Initialization Failed"),t(n)})}),Mt=e=>new Promise(async(t,n)=>{if(e==null)return t([]);const o=await $fetch("/api/curva/history",{method:"POST",body:{id:e}});(!o||o.length===0)&&j("/c/");try{t(o.map(i=>Te({...i,t:new Date(i.t),done:!0})))}catch{j("/c/"),t([])}}),ke=async function(e){return[]},Bt=async()=>{try{const e=l.value.at(-1),t=await ke(e.Q),n=C.isAtBottom();e.more=t,n&&C()}catch(e){console.error(e)}},ee=(e=!1)=>{x.value="gpt4",M.value=!0,B.value=.5,e&&h.success("Conversation settings have been reset.")};ee();const y=v(!1),te=v(y.value),ne=v(y.value);k(te,e=>{y.value=e});k(ne,e=>{y.value=e});k(y,e=>{const{isMobileScreen:t}=$();te.value=t?!1:e,ne.value=t?e:!1,setTimeout(()=>g(),0)});{let e,t=$().isMobileScreen?"drawer":"sidebar";window.addEventListener("resize",()=>{clearTimeout(e),e=setTimeout(()=>{const n=$().isMobileScreen?"drawer":"sidebar";y.value&&n!=t&&(y.value=!1,setTimeout(()=>{y.value=!0},0),t=n)},100)})}const D=v(""),It=ye(()=>x.value.startsWith("gpt3")?16e3:32e3),Lt=(()=>{const e=()=>[77,68,53].map(o=>String.fromCharCode(o)).join(""),t=(o,i)=>({hash:yt(o,e(),i),timestamp:we(i)}),n=(o,i,c,s,A,T,w)=>{let f=d();return f||(f=he.base64(8),S.value.unshift({id:f,name:"",mtime:Date.now(),config:""}),j(`/c/${f}?feature=new`),Me(f)),{conv:f,messages:o,model:i,temperature:c,t:s,tz:A,id:T,streamId:w}};return async(o,i)=>{const c=new Date,s=c.getTime(),A=c.getTimezoneOffset()/60*-1,T=(()=>{if(!M.value)return[{role:"user",content:(o==null?void 0:o.Q)||""}];const w=l.value.lastIndexOf(o)+1||l.value.length;let f=l.value.slice(0,w);return f=f.slice(f.length-100),f.map(I=>[{role:"user",content:I.Q},{role:"assistant",content:I.A}].filter(se=>se.content)).flat()})();try{const w=n(T,x.value,B.value,s,A,o==null?void 0:o.id,i),f=t(T,s);return await $fetch("/api/curva/answer",{method:"POST",headers:f,body:w})}catch(w){return{answer:"",error:(w==null?void 0:w.message)||"Error while sending request."}}}})(),$t=(e="",t="",n=!1)=>Te({done:n,Q:e,A:t,queries:[],urls:[],dt:void 0,t:new Date}),N=new Set,F=()=>{S.value=[],l.value=[],j("/c/"),V=!0};let V=!0;function ge(){{const e=at();e.get("feature")==="new"&&(e.delete("feature"),e.save(),re())}}const oe=(e,t)=>{const n=document.createElement("a");n.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(t)),n.setAttribute("download",e),n.style.display="none",document.body.appendChild(n),n.click(),n.remove()},[Qt,d,Me]=(()=>{const e=v("");return[ye(()=>e.value),()=>e.value,t=>{var n,o;return e.value=t===void 0?(o=(n=Y._route)==null?void 0:n.params)==null?void 0:o.conv:t}]})(),W=()=>{var t;const e=d();return((t=S.value.find(n=>n.id===e))==null?void 0:t.name)||""};async function re(e,t){return e=e||d(),e?await $fetch("/api/curva/conv",{method:"PUT",body:{id:e,name:t||W(),config:xt({model:x.value,temperature:B.value,context:M.value})}}):{cancel:!0}}let K=!1;const qt=e=>{var o,i;if(e===void 0&&(e=d()),e==null)return;const t=St(((o=S.value.find(c=>c.id===e))==null?void 0:o.config)||""),n=Object.keys(t);if(n.length===0)ee();else{K=!0;try{for(const c of n){const s=t[c];switch(c){case"model":const A=(i=J.find(T=>T.value===s))==null?void 0:i.redirectTo;x.value=A||s;break;case"temperature":B.value=s;break;case"context":M.value=s;break}}}finally{K=!1}}h.info("Conversation settings have been loaded.")};setTimeout(()=>{let e;[x,M,B].forEach(t=>{k(t,(n,o)=>{Y&&!K&&n!==o&&N.size===0&&(clearTimeout(e),e=setTimeout(async()=>{try{const{cancel:i=!1}=await re();i||h.info("Conversation settings have been saved.")}catch(i){console.error(i),h.warning("Failed to save conversation settings.")}finally{clearTimeout(e)}},typeof t.value=="number"?500:0))})})},1e3);const Dt=(e,t)=>{t!==void 0&&(e[t]="");const{id:n,Q:o,A:i}=e;l.value=l.value.filter(c=>c.Q||c.A),$fetch("/api/curva/message",{method:"PUT",body:{conv:d(),id:n,Q:o,A:i}}).then(()=>h.info(`The message has been ${t?"deleted":"saved"}.`)).catch(()=>h.error(`An error occurred while ${t?"deleting":"saving"} the message.`))},Nt=()=>{let e=0;const t=`${P.convert(d(),"64w",10)}.md`,n=l.value.map(o=>{e++;try{return(o.t?`${new Date(o.t.getTime()-(o.dt||0)).toLocaleString()}${o.dt===void 0?"":" (Î”t: "+o.dt.toString()+"ms)"}

`:"")+(o.Q?`QUESTION ${e}:

${o.Q.replaceAll(`
`,`

`)}`:"")+(o.Q&&o.A?`

`:"")+(o.A?`ANSWER ${e}:

${o.A}`:"")}catch{return"(Unknown message)"}}).join(`

---

`)+`

---

`;oe(t,n)},Wt=()=>{const e=l.value.map(t=>[{role:"user",content:t.Q},{role:"assistant",content:t.A}]).flat().filter(t=>t.content);oe(`${P.convert(d(),"64w",10)}.json`,JSON.stringify(e,null,4))},jt=()=>{const e=l.value.map(t=>{var n,o;return[{role:"user",content:t.Q},{role:"assistant",content:t.A,queries:(n=t.queries)!=null&&n.length?t.queries:void 0,urls:(o=t.urls)!=null&&o.length?t.urls:void 0,createdAt:new Date(t.t.getTime()).toUTCString(),timeUsed:t.dt||void 0}]}).flat().filter(t=>t.content);oe(`${P.convert(d(),"64w",10)}.json`,JSON.stringify(e,null,4))};document.addEventListener("keyup",e=>{switch(e.key){case"/":case"Enter":g();break;case"Escape":y.value=!y.value;break}});const Be=v(!1);document.addEventListener("scroll",()=>{Be.value=!nt()});function Jt(){const{authEventTarget:e}=it(),t=de("appName").value,n=ot();["temperature-suffix","web-browsing","temperature"].forEach(a=>{n.delete(a,{path:"/"}),n.delete(a)}),Y=rt();const o=()=>{setTimeout(()=>{try{ve(`${W()||s("chat.title")} - ${t}`)}catch{ve(`${s("chat.title")} - ${t}`)}},0)};e.addListener("login",F),e.addListener("logout",F);const i=async a=>{setTimeout(()=>{$().isMobileScreen&&(y.value=!1)},0),l.value=[];const m=G.service({text:s("chat.ldConv")+"...",lock:!0});try{const b=a===null&&S.value.length>0?null:q(),p=a===null?null:await Mt(a);p!==null&&d()===a&&(l.value=p,Bt()),await Promise.all([b,C(1e3)]),qt(a),setTimeout(()=>o(),1e3)}finally{m.close(),await C(500),g(),Pe(),await C(500)}},c=async(a,m=!1)=>{Me(a||"");const b=Promise.all([...N]),p=V&&m?new Promise(async r=>{await i(a),ge(),r(null)}):m?new Promise(r=>r(null)):i(a);V=!1,N.add(p);try{await b}catch{}try{await p}finally{N.delete(p)}},s=st().t,A=de("version"),T=async(a,m)=>{if(!x.value)return h.info("Please select a model."),g(),!1;if(document.querySelectorAll(".Message.T").length>0)return h.info("Please wait for the completion of the previous question."),g(),!1;const p=(a!==void 0?a:D.value).trim();if(a===void 0&&(D.value="",p===""))return g(),!1;const r=(m?l.value.filter(u=>u.id===m).at(-1):void 0)||$t(p,"",!1);l.value.includes(r)||l.value.push(r);const H=r.A||"";r.done=!1,r.Q=p,r.A="",r.urls=[],r.queries=[],r.dt&&(r.dt=void 0);const Ie=ke(),Le=C.isAtBottom(),$e=d();Le&&C(),g();const U=1;let Q=!1;const Qe=await new Promise(async u=>{var ue;if(!((ue=J.find(_=>_.value===x.value))!=null&&ue.isStreamAvailable))return u(void 0);const O=[],Ue=setInterval(()=>{O.length&&(r.A+=O.shift(),C.keepAtBottom()),r.done&&(clearInterval(Ue),ie.abort())},U),ie=new AbortController,_e=await fetch("/api/curva/stream",{method:"POST",headers:{"Content-Type":"application/json"},body:"{}",signal:ie.signal}),Ge=new TextDecoder,Re=_e.body.getReader();let ce=!1;const le=async()=>{await Re.read().then(async({value:_,done:ze})=>{if(ze){if(O.length===0){r.done=!0;return}Q=!0;const Fe=setInterval(()=>{O.length===0&&(r.done=!0,Q=!1,clearInterval(Fe))},U);return}const fe=Ge.decode(_);ce?O.push(fe):(u(fe),ce=!0),le()})};le()}),qe=await Lt(r,Qe);ge(),pe!==$e&&q().finally(()=>{pe=d()});const{id:De,answer:L="",error:E,urls:Ne=[],queries:We=[],dt:je=0,version:ae}=qe;if(Q){const u=setInterval(()=>{Q||(r.done=!0,r.A!==L&&(r.A=L||""),clearInterval(u))},U)}else r.done=!0,r.A!==L&&(r.A=L||"");r.t=new Date,r.dt=je||void 0,r.id=De||void 0,r.urls=Ne||[],r.queries=We||[];const He=(u=>u?(u.type==="warning"?h.warning(u.content):h.error(u.content),r.A="Oops! Something went wrong!",!0):!1)((()=>{if(L===""){if(E){const u=()=>{m?r.A=H:(l.value.pop(),D.value=p)};if(typeof E=="string"&&E.startsWith("You have tried too many times."))return u(),{type:"warning",content:E};switch(E){case"THINKING":return u(),{type:"warning",content:bt.get(E)};default:return{type:"error",content:E}}}return{type:"error",content:s("error.plzRefresh")}}})());return setTimeout(async()=>{if(ae&&ae!==A.value){const u=setTimeout(()=>location.reload(),3e3);R.confirm(s("action.newVersion"),s("message.notice"),{confirmButtonText:s("message.ok"),cancelButtonText:s("message.cancel"),type:"warning"}).then(()=>g()).catch(()=>g()).finally(()=>{clearTimeout(u),G.service({text:"Loading...",lock:!0}),location.reload()})}},0),Ie.then(u=>{const O=C.isAtBottom();r.more=u,O&&C()}),He};return{models:J,showScrollToBottomButton:Be,isEditingQuestion:X,editingQuestion:Se,editingQuestionContent:xe,callEditQuestionDialog:Et,isEditingAnswer:Z,editingAnswer:Ee,editingAnswerContent:Oe,callEditAnswerDialog:Pt,model:x,conversations:S,messages:l,temperature:B,contextMode:M,openMenu:y,openSidebarController:te,openDrawerController:ne,inputValue:D,inputMaxLength:It,currentConvIdComputed:Qt,getCurrentConvId:d,getCurrentConvName:W,checkTokenAndGetConversations:q,loadChat:c,sendMessage:T,updateMessage:Dt,regenerateMessage:async a=>{if(l.value.length===0)return;const{Q:m,id:b}=a||l.value.pop();T(m||"",b)},focusInput:g,refreshConversation:()=>{c(d()).finally(()=>g())},renameConversation:(a,m="")=>{a||(a=d(),m=W()),R.prompt(s("message.renameConvHint"),s("message.setting"),{confirmButtonText:s("message.ok"),cancelButtonText:s("message.cancel"),inputValue:m,inputPlaceholder:P.convert(a,"64w",10)}).then(async({value:b})=>{try{await re(a,b),h({type:"success",message:s("message.renameSuccess")}),await q(),o()}catch{h({type:"error",message:"Oops! Something went wrong!"})}}).catch(()=>{})},deleteConversation:a=>{const m=a||d();let b="createNewChat";R.confirm(s("message.deleteConvConfirm"),s("message.warning"),{confirmButtonText:s("message.ok"),cancelButtonText:s("message.cancel"),type:"warning"}).then(async()=>{var r;const p=G.service({text:s("chat.dltConv")+"...",lock:!0});try{await $fetch("/api/curva/conv",{method:"DELETE",body:{id:m}})}catch{}p.close(),a===d()&&((r=document.getElementById(b))==null||r.click()),S.value=S.value.filter(H=>H.id!==a)})},resetConvConfig:ee,exportAsMarkdown:Nt,exportAsJson:Wt,exportAsJsonDetailed:jt,clear:F}}export{Jt as u};
