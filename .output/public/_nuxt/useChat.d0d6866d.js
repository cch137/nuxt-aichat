import{cg as Je,ch as Ve,ci as Ke,cj as Ye,r as v,h as k,Y as ge,W as Xe,E as g,i as fe,ck as Ze,D as et,g as tt,A as j,V as T,z as _,l as ye,cl as nt}from"./entry.410c7428.js";import{E as G}from"./el-overlay.811c6dc1.js";import"./el-button.eccf52a4.js";import"./el-input.c345d471.js";import{t as ot,r as we,b as P,m as st,a as rt,c as at,s as Te}from"./random.b9e6a60b.js";import{u as it}from"./useAuth.c8a716ce.js";import{u as de}from"./useTitle.840afa2f.js";var ct=Ve,lt=Ke,ut=Ye,ft={formats:ut,parse:lt,stringify:ct};const Ce=Je(ft),dt={get isMobileScreen(){return window.innerWidth<600},get isTouchScreen(){return"ontouchstart"in document||navigator.maxTouchPoints>0}};function $(){return dt}const{MT:ve,shuffle:vt,randInt:z}=we,{convert:mt,getCharset:pt}=P,ht=(e,t)=>{const n=vt(e,t);return()=>(n.push(n.shift()),n)},be=(e,t=16,n=1,o)=>{const a=Number.isNaN(+t)?64:+t,l=pt(t),i=ot(o!==void 0?o:z(0,a)),x=ve(i),C=ht(l,ve(z(0,1e6,x))),A=typeof e=="string"?e.split(""):e,f=[o!==void 0?l[z(0,a)]:mt(i,10,t),...A.map(B=>C()[l.indexOf(B)])];return--n<1?f.join(""):be(f,t,n,o)},{textToBase64:gt,base64ToText:Jt,secureBase64:yt}=P;function wt(e,t=1,n){return typeof e=="object"?e=at(e):typeof e!="string"&&(e=Te(e)),be(yt(gt(e)),64,t,n)}function Tt(e,t=512,n){const o=wt(e,1,n).substring(1);return t==="MD5"?st(o).toString():rt(o,{outputLength:t}).toString()}const Ct=new Map([["THINKING","Please wait, I am answering another question..."]]);function bt(e,t){switch(e){case"model":if(["gpt3","gpt4","gpt-web","claude-2-web","gpt3-fga"].includes(t))return!0;break;case"temperature":if(typeof t=="number"&&t>=0&&t<=1)return!0;break;case"context":if(typeof t=="boolean")return!0;break}return!1}function At(e){try{return JSON.parse(e)}catch{return e}}function Ae(e){try{const t={};for(const n in e){const o=At(e[n]);bt(n,o)&&(t[n]=o)}return t}catch{return{}}}function St(e){try{return Ae(Ce.parse(e))}catch{return{}}}function xt(e){try{return Ce.stringify(Ae(e))}catch{return""}}const me=[{name:"GPT-3.5-Turbo",value:"gpt3",isWebBrowsingOptional:!1,isTemperatureOptional:!0,isContextOptional:!0,isStreamAvailable:!1,permissionLevel:1},{name:"GPT-4",value:"gpt4",isWebBrowsingOptional:!1,isTemperatureOptional:!0,isContextOptional:!0,isStreamAvailable:!1,permissionLevel:1},{name:"GPT-Web",value:"gpt-web",isWebBrowsingOptional:!1,isTemperatureOptional:!0,isContextOptional:!0,isStreamAvailable:!1,permissionLevel:1},{name:"Claude-2",value:"claude-2",isWebBrowsingOptional:!1,isTemperatureOptional:!1,isContextOptional:!0,isStreamAvailable:!0,permissionLevel:1},{name:"Claude-2 (Web)",value:"claude-2-web",isWebBrowsingOptional:!1,isTemperatureOptional:!1,isContextOptional:!0,isStreamAvailable:!0,permissionLevel:1},{name:"GPT-3.5-Turbo (stream)",value:"gpt3-fga",isWebBrowsingOptional:!1,isTemperatureOptional:!0,isContextOptional:!0,isStreamAvailable:!0,permissionLevel:1}];let K,pe="";const S=v("gpt4"),I=v(!0),M=v(.5),c=v([]),b=v([]),Se=v(),Y=v(!1),xe=v("");function Et(e){Y.value=!0,Se.value=e,xe.value=e.Q,setTimeout(()=>Ot(),0)}function Ot(){try{document.querySelector(".EditQuestionInput textarea").focus()}catch{}}k(Y,e=>e?null:h());const Ee=v(),X=v(!1),Oe=v("");function kt(e){X.value=!0,Ee.value=e,Oe.value=e.A,setTimeout(()=>Pt(),0)}function Pt(){try{document.querySelector(".EditAnswerInput textarea").focus()}catch{}}k(X,e=>e?null:h());const h=()=>{try{{if($().isMobileScreen)return;const e=document.querySelector(".InputBox textarea");e.click(),e.focus()}}catch{}},ke=()=>{try{const e=document.getElementById(d()).parentElement,t=document.querySelector(".ConversationList"),n=e.offsetTop-t.offsetTop-e.clientHeight/2,o=n-t.clientHeight+e.clientHeight*2;t.scrollTop>n&&t.scrollTo({left:0,top:n,behavior:"smooth"}),t.scrollTop<o&&t.scrollTo({left:0,top:o,behavior:"smooth"})}catch{}},q=()=>new Promise((e,t)=>{$fetch("/api/curva/check",{method:"POST"}).then(n=>{b.value=n,ke(),e(!0)}).catch(n=>{g.error("Initialization Failed"),t(n)})}),It=e=>new Promise(async(t,n)=>{if(e==null)return t([]);const o=await $fetch("/api/curva/history",{method:"POST",body:{id:e}});(!o||o.length===0)&&j("/c/");try{t(o.map(a=>ye({...a,t:new Date(a.t),done:!0})))}catch{j("/c/"),t([])}}),Pe=async function(e){return[]},Mt=async()=>{try{const e=c.value.at(-1),t=await Pe(e.Q),n=T.isAtBottom();e.more=t,n&&T()}catch(e){console.error(e)}},Z=(e=!1)=>{S.value="gpt4",I.value=!0,M.value=.5,e&&g.success("Conversation settings have been reset.")};Z();const y=v(!1),ee=v(y.value),te=v(y.value);k(ee,e=>{y.value=e});k(te,e=>{y.value=e});k(y,e=>{const{isMobileScreen:t}=$();ee.value=t?!1:e,te.value=t?e:!1,setTimeout(()=>h(),0)});{let e,t=$().isMobileScreen?"drawer":"sidebar";window.addEventListener("resize",()=>{clearTimeout(e),e=setTimeout(()=>{const n=$().isMobileScreen?"drawer":"sidebar";y.value&&n!=t&&(y.value=!1,setTimeout(()=>{y.value=!0},0),t=n)},100)})}const D=v(""),Bt=ge(()=>S.value.startsWith("gpt3")?16e3:32e3),Lt=(()=>{const e=()=>[77,68,53].map(o=>String.fromCharCode(o)).join(""),t=(o,a)=>({hash:Tt(o,e(),a),timestamp:Te(a)}),n=(o,a,l,i,x,C,A)=>{let f=d();return f||(f=we.base64(8),b.value.unshift({id:f,name:"",mtime:Date.now(),config:""}),j(`/c/${f}?feature=new`),Ie(f)),{conv:f,messages:o,model:a,temperature:l,t:i,tz:x,id:C,streamId:A}};return async(o,a)=>{const l=new Date,i=l.getTime(),x=l.getTimezoneOffset()/60*-1,C=(()=>{if(!I.value)return[{role:"user",content:(o==null?void 0:o.Q)||""}];const A=c.value.lastIndexOf(o)+1||c.value.length;let f=c.value.slice(0,A);return f=f.slice(f.length-100),f.map(B=>[{role:"user",content:B.Q},{role:"assistant",content:B.A}].filter(se=>se.content)).flat()})();try{const A=n(C,S.value,M.value,i,x,o==null?void 0:o.id,a),f=t(C,i);return await $fetch("/api/curva/answer",{method:"POST",headers:f,body:A})}catch{return{answer:"",error:"Error while sending request."}}}})(),$t=(e="",t="",n=!1)=>ye({done:n,Q:e,A:t,queries:[],urls:[],dt:void 0,t:new Date}),N=new Set,F=()=>{b.value=[],c.value=[],j("/c/"),J=!0};let J=!0;function he(){{const e=nt();e.get("feature")==="new"&&(e.delete("feature"),e.save(),oe())}}const ne=(e,t)=>{const n=document.createElement("a");n.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(t)),n.setAttribute("download",e),n.style.display="none",document.body.appendChild(n),n.click(),n.remove()},[Qt,d,Ie]=(()=>{const e=v("");return[ge(()=>e.value),()=>e.value,t=>{var n,o;return e.value=t===void 0?(o=(n=K._route)==null?void 0:n.params)==null?void 0:o.conv:t}]})(),W=()=>{var t;const e=d();return((t=b.value.find(n=>n.id===e))==null?void 0:t.name)||""};async function oe(e,t){return e=e||d(),e?await $fetch("/api/curva/conv",{method:"PUT",body:{id:e,name:t||W(),config:xt({model:S.value,temperature:M.value,context:I.value})}}):{cancel:!0}}let V=!1;const qt=e=>{var o;if(e===void 0&&(e=d()),e==null)return;const t=St(((o=b.value.find(a=>a.id===e))==null?void 0:o.config)||""),n=Object.keys(t);if(n.length===0)Z();else{V=!0;try{for(const a of n){const l=t[a];switch(a){case"model":S.value=l;break;case"temperature":M.value=l;break;case"context":I.value=l;break}}}finally{V=!1}}g.info("Conversation settings have been loaded.")};setTimeout(()=>{let e;[S,I,M].forEach(t=>{k(t,(n,o)=>{K&&!V&&n!==o&&N.size===0&&(clearTimeout(e),e=setTimeout(async()=>{try{const{cancel:a=!1}=await oe();a||g.info("Conversation settings have been saved.")}catch(a){console.error(a),g.warning("Failed to save conversation settings.")}finally{clearTimeout(e)}},typeof t.value=="number"?500:0))})})},1e3);const Dt=(e,t)=>{t!==void 0&&(e[t]="");const{id:n,Q:o,A:a}=e;c.value=c.value.filter(l=>l.Q||l.A),$fetch("/api/curva/message",{method:"PUT",body:{conv:d(),id:n,Q:o,A:a}}).then(()=>g.info(`The message has been ${t?"deleted":"saved"}.`)).catch(()=>g.error(`An error occurred while ${t?"deleting":"saving"} the message.`))},Nt=()=>{let e=0;const t=`${P.convert(d(),"64w",10)}.md`,n=c.value.map(o=>{e++;try{return(o.t?`${new Date(o.t.getTime()-(o.dt||0)).toLocaleString()}${o.dt===void 0?"":" (Î”t: "+o.dt.toString()+"ms)"}

`:"")+(o.Q?`QUESTION ${e}:

${o.Q.replaceAll(`
`,`

`)}`:"")+(o.Q&&o.A?`

`:"")+(o.A?`ANSWER ${e}:

${o.A}`:"")}catch{return"(Unknown message)"}}).join(`

---

`)+`

---

`;ne(t,n)},Wt=()=>{const e=c.value.map(t=>[{role:"user",content:t.Q},{role:"assistant",content:t.A}]).flat().filter(t=>t.content);ne(`${P.convert(d(),"64w",10)}.json`,JSON.stringify(e,null,4))},jt=()=>{const e=c.value.map(t=>{var n,o;return[{role:"user",content:t.Q},{role:"assistant",content:t.A,queries:(n=t.queries)!=null&&n.length?t.queries:void 0,urls:(o=t.urls)!=null&&o.length?t.urls:void 0,createdAt:new Date(t.t.getTime()).toUTCString(),timeUsed:t.dt||void 0}]}).flat().filter(t=>t.content);ne(`${P.convert(d(),"64w",10)}.json`,JSON.stringify(e,null,4))};document.addEventListener("keyup",e=>{switch(e.key){case"/":case"Enter":h();break;case"Escape":y.value=!y.value;break}});const Me=v(!1);document.addEventListener("scroll",()=>{Me.value=!Xe()});function Vt(){const{authEventTarget:e}=it(),t=fe("appName").value,n=Ze();["temperature-suffix","web-browsing","temperature"].forEach(r=>{n.delete(r,{path:"/"}),n.delete(r)}),K=et();const o=()=>{setTimeout(()=>{try{de(`${W()||i("chat.title")} - ${t}`)}catch{de(`${i("chat.title")} - ${t}`)}},0)};e.addListener("login",F),e.addListener("logout",F);const a=async r=>{setTimeout(()=>{$().isMobileScreen&&(y.value=!1)},0),c.value=[];const m=_.service({text:i("chat.ldConv")+"...",lock:!0});try{const w=r===null&&b.value.length>0?null:q(),p=r===null?null:await It(r);p!==null&&d()===r&&(c.value=p,Mt()),await Promise.all([w,T(1e3)]),qt(r),setTimeout(()=>o(),1e3)}finally{m.close(),await T(500),h(),ke(),await T(500)}},l=async(r,m=!1)=>{Ie(r||"");const w=Promise.all([...N]),p=J&&m?new Promise(async s=>{await a(r),he(),s(null)}):m?new Promise(s=>s(null)):a(r);J=!1,N.add(p);try{await w}catch{}try{await p}finally{N.delete(p)}},i=tt().t,x=fe("version"),C=async(r,m)=>{if(document.querySelectorAll(".Message.T").length>0)return g.info("Please wait for the completion of the previous question."),h(),!1;const p=(r!==void 0?r:D.value).trim();if(r===void 0&&(D.value="",p===""))return h(),!1;const s=(m?c.value.filter(u=>u.id===m).at(-1):void 0)||$t(p,"",!1);c.value.includes(s)||c.value.push(s);const U=s.A||"";s.done=!1,s.Q=p,s.A="",s.urls=[],s.queries=[],s.dt&&(s.dt=void 0);const Be=Pe(),Le=T.isAtBottom(),$e=d();Le&&T(),h();const H=1;let Q=!1;const Qe=await new Promise(async u=>{var le;if(!((le=me.find(R=>R.value===S.value))!=null&&le.isStreamAvailable))return u(void 0);const O=[],He=setInterval(()=>{O.length&&(s.A+=O.shift(),T.keepAtBottom()),s.done&&(clearInterval(He),ae.abort())},H),ae=new AbortController,Re=await fetch("/api/curva/stream",{method:"POST",headers:{"Content-Type":"application/json"},body:"{}",signal:ae.signal}),_e=new TextDecoder,Ge=Re.body.getReader();let ie=!1;const ce=async()=>{await Ge.read().then(async({value:R,done:ze})=>{if(ze){if(O.length===0){s.done=!0;return}Q=!0;const Fe=setInterval(()=>{O.length===0&&(s.done=!0,Q=!1,clearInterval(Fe))},H);return}const ue=_e.decode(R);ie?O.push(ue):(u(ue),ie=!0),ce()})};ce()}),qe=await Lt(s,Qe);he(),pe!==$e&&q().finally(()=>{pe=d()});const{id:De,answer:L="",error:E,urls:Ne=[],queries:We=[],dt:je=0,version:re}=qe;if(Q){const u=setInterval(()=>{Q||(s.done=!0,s.A!==L&&(s.A=L||""),clearInterval(u))},H)}else s.done=!0,s.A!==L&&(s.A=L||"");s.t=new Date,s.dt=je||void 0,s.id=De||void 0,s.urls=Ne||[],s.queries=We||[];const Ue=(u=>u?(u.type==="warning"?g.warning(u.content):g.error(u.content),s.A="Oops! Something went wrong!",!0):!1)((()=>{if(L===""){if(E){const u=()=>{m?s.A=U:(c.value.pop(),D.value=p)};if(typeof E=="string"&&E.startsWith("You have tried too many times."))return u(),{type:"warning",content:E};switch(E){case"THINKING":return u(),{type:"warning",content:Ct.get(E)};default:return{type:"error",content:E}}}return{type:"error",content:i("error.plzRefresh")}}})());return setTimeout(async()=>{if(re&&re!==x.value){const u=setTimeout(()=>location.reload(),3e3);G.confirm(i("action.newVersion"),i("message.notice"),{confirmButtonText:i("message.ok"),cancelButtonText:i("message.cancel"),type:"warning"}).then(()=>h()).catch(()=>h()).finally(()=>{clearTimeout(u),_.service({text:"Loading...",lock:!0}),location.reload()})}},0),Be.then(u=>{const O=T.isAtBottom();s.more=u,O&&T()}),Ue};return{models:me,showScrollToBottomButton:Me,isEditingQuestion:Y,editingQuestion:Se,editingQuestionContent:xe,callEditQuestionDialog:Et,isEditingAnswer:X,editingAnswer:Ee,editingAnswerContent:Oe,callEditAnswerDialog:kt,model:S,conversations:b,messages:c,temperature:M,contextMode:I,openMenu:y,openSidebarController:ee,openDrawerController:te,inputValue:D,inputMaxLength:Bt,currentConvIdComputed:Qt,getCurrentConvId:d,getCurrentConvName:W,checkTokenAndGetConversations:q,loadChat:l,sendMessage:C,updateMessage:Dt,regenerateMessage:async r=>{if(c.value.length===0)return;const{Q:m,id:w}=r||c.value.pop();C(m||"",w)},focusInput:h,refreshConversation:()=>{l(d()).finally(()=>h())},renameConversation:(r,m="")=>{r||(r=d(),m=W()),G.prompt(i("message.renameConvHint"),i("message.setting"),{confirmButtonText:i("message.ok"),cancelButtonText:i("message.cancel"),inputValue:m,inputPlaceholder:P.convert(r,"64w",10)}).then(async({value:w})=>{try{await oe(r,w),g({type:"success",message:i("message.renameSuccess")}),await q(),o()}catch{g({type:"error",message:"Oops! Something went wrong!"})}}).catch(()=>{})},deleteConversation:r=>{const m=r||d();let w="createNewChat";G.confirm(i("message.deleteConvConfirm"),i("message.warning"),{confirmButtonText:i("message.ok"),cancelButtonText:i("message.cancel"),type:"warning"}).then(async()=>{var s;const p=_.service({text:i("chat.dltConv")+"...",lock:!0});try{await $fetch("/api/curva/conv",{method:"DELETE",body:{id:m}})}catch{}p.close(),r===d()&&((s=document.getElementById(w))==null||s.click()),b.value=b.value.filter(U=>U.id!==r)})},resetConvConfig:Z,exportAsMarkdown:Nt,exportAsJson:Wt,exportAsJsonDetailed:jt,clear:F}}export{Vt as u};
